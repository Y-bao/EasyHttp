/*
* easy-http v1.0.3
* (c) 2018-2019 PengYuan-Jiang
*/
"use strict";function t(t,e){return null==t?t===e:t.constructor===e||t instanceof e}var e={initDictate(t){if(t){let e,r=t.split(":");for(let t=0,s=r.length;t<s;t++){let s=r[t];s&&(e||(e=[])).push(s)}return e}}};const r=/(?:{([^{}]*))?{\s*([a-z_][a-z0-9_]*)\s*((?::[a-z_][a-z0-9_]*)*)\s*}(?:([^{}]*)})?/gi,s={TEXT:"text",CMD:"cmd"},i=Symbol("privateScope");const n=class{constructor(t){this[i]={};let n=t;if(!n)return;let a,o,h=this[i].nodes=[],d=0;for(;o=r.exec(n);){a||(a=this[i].keys=[]);let t=o.index;d<t&&h.push({type:s.TEXT,data:n.substring(d,t)});let r=o[2],c=e.initDictate(o[3])||void 0;h.push({type:s.CMD,data:{key:r,dictates:c||void 0,prefix:o[1]||void 0,suffix:o[4]||void 0}}),a[r]=1,d=t+o[0].length}let c=n.length;d<c&&h.push({type:s.TEXT,data:n.substring(d,c)})}get nodes(){return this[i].nodes}get keys(){return this[i].keys}toRequestTpl(){if(!this.nodes)return"";let t="";for(let e=0,r=this.nodes.length;e<r;e++){let r=this.nodes[e],i="";switch(r.type){case s.CMD:i=r.data.key,r.data.dictates&&(i=`${i}:${r.data.dictates.join(":")}`),i=`{${i}}`,(r.data.prefix||r.data.suffix)&&(i=`{${r.data.prefix||""}${i}${r.data.suffix||""}}`);break;case s.TEXT:default:i=r.data}t+=i}return t}},a=Symbol("privateScope");class o{constructor(e,r){if(this[a]={configGetter:e},r)if(t(r,Object)){let t;(t=r.action||r.a)&&(this[a].action=t),(t=r.urlFormat||r.u)&&(this[a].urlFormat=t),(t=r.dictate||r.d)&&(this[a].requestDictate=t)}else this[a].urlFormat=r}get conf(){return this[a].configGetter}get action(){return this[a].action}get urlFormat(){return this[a].urlFormat}get requestDictate(){return this[a].requestDictate}get odl(){return["odl"]in this[a]||(this[a].odl=this.urlFormat&&new n(this.urlFormat)||void 0),this[a].odl}analysis(t){let e=this.odl.nodes;t={...t||{}};let r="";for(let i=0,n=e.length;i<n;i++){let n,a=e[i];switch(a.type){case s.TEXT:n=a.data;break;case s.CMD:let e=a.data,r=t[e.key];delete t[e.key];let i=this.serializater;if(r=i(r),e.dictates&&e.dictates.forEach(t=>{let e=this.dictateMap(t);e&&(r=e(r))}),void 0===r)continue;n=(e.prefix||"")+r+(e.suffix||"")}r+=n}let i,n=this.baseUrl+r;for(let e in t){let r=t[e];void 0!==r&&(i=(i?i+"&":"")+e+"="+r)}return i&&(n+=(n.indexOf("?")<0?"?":"&")+i),n}}class h{constructor(t){this.ro=t}get handler(){return this.createHandler()}createHandler(){let t,e=this,r=function(t){let s=new Promise((s,i)=>{let n=r.getUrl(t&&t.params),a=e.ro.action,o={url:n,params:t&&t.params,action:a,data:t&&t.data,other:t&&t.other,header:t.header?{...r.getHeader(),...t.header}:r.getHeader()},h=e.ro.handler;if(h){let t=e.ro.preHandlers;if(t&&t.length>0)for(let e=0,r=t.length;e<r;e++)if(t[e](o,s,i))return;try{h(o).then(t=>{s({request:o,response:t})}).catch(t=>{i({errType:0,request:o,response:t})})}catch(t){i({errType:-1,request:o,msg:t})}}else i({errType:-1,request:o,msg:"not found handler"})}),i=e.ro.postHandlers;return i&&i.length>0?Promise.resolve().then(()=>{let t=s;for(let e=0,r=i.length;e<r;e++)t=i[e](t);return t}):s};return r.setHeader=function(e){return t=e?{...e}:null,r},r.addHeader=function(e){return e?(t={...this.getHeader(),...e},r):r},r.getHeader=function(){return t||e.ro.header},r.getUrl=function(t){return e.ro.analysis(t)},r}}const d="get",c=function(e){return t(e,Object)&&(e=JSON.stringify(e)),e},l=Symbol("privateScope");class u{constructor(){this[l]={}}init(t){t&&(this.setBaseUrl(t.baseUrl),this.setAction(t.action),this.setDictate(t.dictate),this.setHeaders(t.headers),this.setRequestHandler(t.requestHandler),this.setPreInterceptor(t.preInterceptors),this.setPostInterceptor(t.postInterceptors),this.setSerializater(t.serializater))}setBaseUrl(t){return this[l].baseUrl=t||void 0,this}setAction(t){return this[l].action=t,this}setDictate(t){return this[l].dictates=e.initDictate(t),this}setHeaders(t){return this[l].headers=t?{...t}:void 0,this}addHeaders(t){return t?(this[l].headers?this[l].headers={...this[l].headers,...t}:this[l].headers={...t},this):this}removeHeaders(...t){this[l].headers&&t&&t.length>0&&t.forEach(t=>{t in this[l].headers&&delete this[l].headers[t]})}setRequestHandler(t){return this[l].requestHandler=t||void 0,this}setPreInterceptor(...t){t&&t.length>0?this[l].preInterceptors=[...t]:this[l].preInterceptors=null}addPreInterceptor(...t){return t&&t.length>0&&(this[l].preInterceptors||(this[l].preInterceptors=[]),this[l].preInterceptors.push(...t)),this}setPostInterceptor(...t){return t&&t.length>0?this[l].postInterceptors=[...t]:this[l].postInterceptors=void 0,this}addPostInterceptor(...t){return t&&t.length>0&&(this[l].postInterceptors||(this[l].postInterceptors=[]),this[l].postInterceptors.push(...t)),this}setDictateHandler(t){return this[l].dictateHandlers=t?{...t}:void 0,this}addDictateHandler(t){return t?(this[l].dictateHandlers?this[l].dictateHandlers={...this[l].dictateHandlers,...t}:this[l].dictateHandlers={...t},this):this}removeDictateHandler(...t){this[l].dictateHandlers&&t&&t.length>0&&t.forEach(t=>{t in this[l].dictateHandlers&&delete this[l].dictateHandlers[t]})}setSerializater(t){return this[l].serializater=t,this}use(t){return t.install(this),this}}const p=new u;class f extends u{get configureGetter(){this[l].configGetter||(this[l].configGetter={get defaultHeaders(){return this[l].headers||p[l].headers},get defaultAction(){return(this[l].action||p[l].action||d).toLowerCase()},get defaultDictates(){return this[l].dictates||p[l].dictates},get baseUrl(){return this[l].baseUrl||p[l].baseUrl},get serializater(){return this[l].serializater||p[l].serializater||c},get requestHandler(){return this[l].requestHandler||p[l].requestHandler},get preInterceptors(){return this[l].preInterceptors||p[l].preInterceptors},get postInterceptors(){return this[l].postInterceptors||p[l].postInterceptors},dictateMap(t){return this[l].dictateHandlers&&this[l].dictateHandlers[t]||p[l].dictateHandlers&&p[l].dictateHandlers[t]}})}}const[g,H,b,y]=[Symbol("requestOptions"),Symbol("requesters"),Symbol("configure"),Symbol("getRequestItem")];class m{constructor(t,e){this[b]=new f,this.setBaseUrl(t).addRequests(e)}[y](t){return this[H]||(this[H]={}),t in this[g]&&!(t in this[H])&&(this[H][t]=new h(this[g][t])),this[H]&&this[H][t]}}Object.defineProperty(m.prototype,"addRequests",{configurable:!1,enumerable:!1,get:function(){return function(t){if(t){this[g]||(this[g]={});for(let e in t)this[g][e]=new o(this[b].configureGetter,t[e]),Object.defineProperty(this,e,{get:function(){let t=this[y](e);return t&&t.handler}})}return this}.bind(this)}});const I=["init","setBaseUrl","setAction","setDictate","setHeaders","addHeaders","removeHeaders","setRequestHandler","setPreInterceptor","addPreInterceptor","setPostInterceptor","addPostInterceptor","setDictateHandler","addDictateHandler","removeDictateHandler","setSerializater"],q=I.length;for(let t=0;t<q;t++){let e=I[t];Object.defineProperty(m,e,{configurable:!1,enumerable:!1,get:function(){return function(){return p[e](...arguments),this}.bind(this)}}),Object.defineProperty(m.prototype,e,{configurable:!1,enumerable:!1,get:function(){return function(){return this[b][e](...arguments),this}.bind(this)}})}module.exports=m;